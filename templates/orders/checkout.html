{% extends 'base.html' %}
{% load static %}

{% block title %}Checkout - EmpressDish{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8 max-w-7xl">
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- Main Content -->
        <div class="lg:col-span-2">
            <h1 class="text-gray-900 dark:text-white text-4xl font-black leading-tight tracking-[-0.033em] mb-4">
                Checkout</h1>
            <p class="text-gray-600 dark:text-gray-400 text-base mb-8">Complete your order by following the steps below
            </p>

            <!-- Step Indicator -->
            <div class="flex mb-8">
                <div class="flex h-12 flex-1 items-center justify-center rounded-xl bg-gray-100 dark:bg-gray-800 p-1.5">
                    <label
                        class="flex cursor-pointer h-full grow items-center justify-center overflow-hidden rounded-lg px-2 bg-white dark:bg-gray-900 shadow-md text-gray-900 dark:text-white text-sm font-medium leading-normal">
                        <span class="truncate">1. Delivery</span>
                        <input checked class="invisible w-0" name="checkout-step" type="radio" value="1" />
                    </label>
                    <label
                        class="flex cursor-pointer h-full grow items-center justify-center overflow-hidden rounded-lg px-2 text-gray-500 dark:text-gray-400 text-sm font-medium leading-normal">
                        <span class="truncate">2. Payment</span>
                        <input class="invisible w-0" name="checkout-step" type="radio" value="2" />
                    </label>
                    <label
                        class="flex cursor-pointer h-full grow items-center justify-center overflow-hidden rounded-lg px-2 text-gray-500 dark:text-gray-400 text-sm font-medium leading-normal">
                        <span class="truncate">3. Confirm</span>
                        <input class="invisible w-0" name="checkout-step" type="radio" value="3" />
                    </label>
                </div>
            </div>

            <!-- Delivery Details Form -->
            <div class="space-y-6">
                <div class="bg-white dark:bg-gray-900 p-6 rounded-xl border border-gray-200 dark:border-gray-800">
                    <h2
                        class="text-gray-900 dark:text-white text-[22px] font-bold leading-tight tracking-[-0.015em] pb-4">
                        Order Type</h2>

                    <!-- Delivery Type Selector -->
                    <div
                        class="mb-6 p-4 bg-gray-50 dark:bg-gray-800/30 rounded-xl border border-gray-200 dark:border-gray-700">
                        <div class="grid grid-cols-2 gap-4">
                            <label
                                class="flex cursor-pointer items-center justify-center gap-3 rounded-lg border-2 border-primary bg-primary/5 p-3 transition-all">
                                <input checked class="form-radio text-primary focus:ring-primary/50"
                                    name="delivery_type" type="radio" value="delivery" />
                                <div class="text-center">
                                    <p class="font-bold text-gray-900 dark:text-white">Delivery</p>
                                    <p class="text-xs text-gray-500">To your door</p>
                                </div>
                            </label>
                            <label
                                class="flex cursor-pointer items-center justify-center gap-3 rounded-lg border-2 border-gray-200 dark:border-gray-700 p-3 transition-all">
                                <input class="form-radio text-primary focus:ring-primary/50" name="delivery_type"
                                    type="radio" value="pickup" />
                                <div class="text-center">
                                    <p class="font-bold text-gray-900 dark:text-white">Pickup</p>
                                    <p class="text-xs text-gray-500">At restaurant</p>
                                </div>
                            </label>
                        </div>
                    </div>

                    <form id="checkout-form" class="space-y-6">
                        {% csrf_token %}

                        <!-- Address Section -->
                        <div id="address-section"
                            class="grid grid-cols-1 md:grid-cols-2 gap-6 pb-6 border-b border-gray-100 dark:border-gray-800">
                            <div class="md:col-span-2">
                                <label class="flex flex-col">
                                    <p
                                        class="text-gray-800 dark:text-gray-300 text-base font-medium leading-normal pb-2">
                                        Delivery Address</p>
                                    <input name="delivery_address"
                                        class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-xl text-gray-900 dark:text-white focus:outline-0 focus:ring-2 focus:ring-primary/50 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800/50 h-14 placeholder:text-gray-400 p-4"
                                        placeholder="Enter your full address" value="{{ user.street_address }}"
                                        required />
                                </label>
                            </div>

                            <div>
                                <label class="flex flex-col">
                                    <p
                                        class="text-gray-800 dark:text-gray-300 text-base font-medium leading-normal pb-2">
                                        City</p>
                                    <input name="delivery_city"
                                        class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-xl text-gray-900 dark:text-white focus:outline-0 focus:ring-2 focus:ring-primary/50 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800/50 h-14 placeholder:text-gray-400 p-4"
                                        placeholder="City" value="{{ user.city }}" required />
                                </label>
                            </div>

                            <div>
                                <label class="flex flex-col">
                                    <p
                                        class="text-gray-800 dark:text-gray-300 text-base font-medium leading-normal pb-2">
                                        State</p>
                                    <input name="delivery_state"
                                        class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-xl text-gray-900 dark:text-white focus:outline-0 focus:ring-2 focus:ring-primary/50 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800/50 h-14 placeholder:text-gray-400 p-4"
                                        placeholder="State" value="{{ user.state }}" required />
                                </label>
                            </div>

                            <div>
                                <label class="flex flex-col">
                                    <p
                                        class="text-gray-800 dark:text-gray-300 text-base font-medium leading-normal pb-2">
                                        Postal Code (Optional)</p>
                                    <input name="delivery_postal_code"
                                        class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-xl text-gray-900 dark:text-white focus:outline-0 focus:ring-2 focus:ring-primary/50 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800/50 h-14 placeholder:text-gray-400 p-4"
                                        placeholder="Postal Code" value="{{ user.postal_code }}" />
                                </label>
                            </div>

                            <div class="md:col-span-2">
                                <p class="text-gray-800 dark:text-gray-300 text-base font-medium leading-normal pb-2">
                                    Delivery Options</p>
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                    <label
                                        class="flex cursor-pointer items-center gap-4 rounded-xl border border-gray-300 dark:border-gray-600 p-4 has-[:checked]:border-primary has-[:checked]:ring-2 has-[:checked]:ring-primary/50">
                                        <input checked class="form-radio text-primary focus:ring-primary/50"
                                            name="delivery-option" type="radio" value="standard" />
                                        <div>
                                            <p class="font-semibold text-gray-800 dark:text-gray-200">Standard Delivery
                                            </p>
                                            <p class="text-sm text-gray-500 dark:text-gray-400">{{ restaurant.estimated_delivery_time }}-{{ restaurant.estimated_delivery_time|add:15 }} min</p>
                                        </div>
                                        <p class="ml-auto font-bold text-gray-900 dark:text-white">{% if restaurant.delivery_fee %}${{ restaurant.delivery_fee }}{% else %}$5.00{% endif %}</p>
                                    </label>
                                    <label
                                        class="flex cursor-pointer items-center gap-4 rounded-xl border border-gray-300 dark:border-gray-600 p-4 has-[:checked]:border-primary has-[:checked]:ring-2 has-[:checked]:ring-primary/50">
                                        <input class="form-radio text-primary focus:ring-primary/50"
                                            name="delivery-option" type="radio" value="express" />
                                        <div>
                                            <p class="font-semibold text-gray-800 dark:text-gray-200">Express Delivery
                                            </p>
                                            <p class="text-sm text-gray-500 dark:text-gray-400">{% if restaurant.estimated_delivery_time %}{{ restaurant.estimated_delivery_time|add:"-10" }}-{{ restaurant.estimated_delivery_time }} min{% else %} 20-30 min {% endif %}</p>
                
                                        </div>
                                        <p class="ml-auto font-bold text-gray-900 dark:text-white">{% if restaurant.delivery_fee %}${{ restaurant.delivery_fee|add:3 }}{% else %}$8.00{% endif %}</p>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- Contact and Payment Section (Always Visible) -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="flex flex-col">
                                    <p
                                        class="text-gray-800 dark:text-gray-300 text-base font-medium leading-normal pb-2">
                                        Full Name</p>
                                    <input name="contact_name"
                                        class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-xl text-gray-900 dark:text-white focus:outline-0 focus:ring-2 focus:ring-primary/50 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800/50 h-14 placeholder:text-gray-400 p-4"
                                        placeholder="Full Name" value="{{ user.get_full_name }}" required />
                                </label>
                            </div>

                            <div>
                                <label class="flex flex-col">
                                    <p
                                        class="text-gray-800 dark:text-gray-300 text-base font-medium leading-normal pb-2">
                                        Phone Number</p>
                                    <input name="contact_phone"
                                        class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-xl text-gray-900 dark:text-white focus:outline-0 focus:ring-2 focus:ring-primary/50 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800/50 h-14 placeholder:text-gray-400 p-4"
                                        placeholder="+1 234 567 890" value="{{ user.phone_number }}" required />
                                </label>
                            </div>

                            <div class="md:col-span-2">
                                <label class="flex flex-col">
                                    <p
                                        class="text-gray-800 dark:text-gray-300 text-base font-medium leading-normal pb-2">
                                        Instructions (Optional)</p>
                                    <textarea name="delivery_instructions"
                                        class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-xl text-gray-900 dark:text-white focus:outline-0 focus:ring-2 focus:ring-primary/50 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800/50 placeholder:text-gray-400 p-4"
                                        rows="3" placeholder="e.g., Gate code, ring doorbell, etc."></textarea>
                                </label>
                            </div>

                            <div class="md:col-span-2">
                                <p class="text-gray-800 dark:text-gray-300 text-base font-medium leading-normal pb-2">
                                    Payment Method</p>
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                    <label class="flex cursor-not-allowed opacity-50 bg-gray-50 dark:bg-gray-800 items-center gap-4 rounded-xl border border-gray-300 dark:border-gray-600 p-4 transition-all">
                                        <input disabled class="form-radio text-gray-400" name="payment_method" type="radio" value="online" />
                                        <div class="flex-1">
                                            <p class="font-semibold text-gray-500 dark:text-gray-500">Pay Now</p>
                                            <p class="text-sm text-gray-400 dark:text-gray-600">Currently unavailable</p>
                                        </div>
                                        <span class="material-symbols-outlined text-2xl text-gray-400">credit_card</span>
                                    </label>
                                    <label
                                        class="flex cursor-pointer items-center gap-4 rounded-xl border border-gray-300 dark:border-gray-600 p-4 has-[:checked]:border-primary has-[:checked]:ring-2 has-[:checked]:ring-primary/50 transition-all">
                                        <input checked class="form-radio text-primary focus:ring-primary/50"
                                            name="payment_method" type="radio" value="cod" />
                                        <div class="flex-1">
                                            <p class="font-semibold text-gray-800 dark:text-gray-200">Cash on Delivery
                                            </p>
                                            <p class="text-sm text-gray-500 dark:text-gray-400">Pay when you receive
                                                your order</p>
                                        </div>
                                        <span class="material-symbols-outlined text-2xl text-green-600">payments</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>

                <div class="flex justify-end">
                    <button onclick="proceedToPayment()"
                        class="flex items-center justify-center gap-2 rounded-xl bg-primary px-8 h-14 text-base font-bold text-white hover:bg-primary/90 transition-colors">
                        <span>Continue to Payment</span>
                        <span class="material-symbols-outlined">arrow_forward</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Order Summary Sidebar -->
        <div class="lg:col-span-1">
            <div class="sticky top-24">
                <div class="bg-white dark:bg-gray-900 p-6 rounded-xl border border-gray-200 dark:border-gray-800">
                    <div class="flex justify-between items-center pb-4 border-b border-gray-200 dark:border-gray-700">
                        <h2
                            class="text-gray-900 dark:text-white text-[22px] font-bold leading-tight tracking-[-0.015em]">
                            Order Summary</h2>
                        <a class="text-sm font-medium text-primary hover:underline" href="{% url 'orders:cart' %}">Edit
                            Order</a>
                    </div>

                    <div class="py-4 space-y-4 max-h-64 overflow-y-auto">
                        {% for item in cart.cart_items.all %}
                        <div class="flex items-center gap-4">
                            <img class="w-16 h-16 rounded-lg object-cover"
                                src="{% if item.menu_item.image %}{{ item.menu_item.image.url }}{% else %}https://images.unsplash.com/photo-1546069901-ba9599a7e63c?w=200{% endif %}"
                                alt="{{ item.menu_item.name }}" />
                            <div class="flex-grow">
                                <p class="font-semibold text-gray-800 dark:text-gray-200">{{ item.menu_item.name }}</p>
                                <p class="text-sm text-gray-500 dark:text-gray-400">Qty: {{ item.quantity }}</p>
                            </div>
                            <p class="font-bold text-gray-900 dark:text-white">${{ item.total_price }}</p>
                        </div>
                        {% endfor %}
                    </div>

                    <!-- Coupon Section -->
                    <div class="py-4 border-t border-gray-200 dark:border-gray-700">
                        <div id="coupon-section">
                            <p class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-3">Have a promo code?</p>
                            <div id="coupon-input-container" class="flex gap-2">
                                <input type="text" id="coupon-code" placeholder="Enter code"
                                    class="flex-1 px-3 py-2 text-sm rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 text-gray-900 dark:text-white placeholder:text-gray-400 focus:outline-none focus:ring-2 focus:ring-primary/50"
                                    maxlength="50">
                                <button onclick="applyCoupon()" id="apply-coupon-btn"
                                    class="px-4 py-2 bg-primary text-white text-sm font-medium rounded-lg hover:bg-primary/90 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">Apply</button>
                            </div>
                            <div id="coupon-message" class="mt-2 text-sm hidden"></div>
                            <div id="applied-coupon"
                                class="hidden mt-3 p-3 bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-lg">
                                <div class="flex justify-between items-center">
                                    <div class="flex items-center gap-2">
                                        <span
                                            class="material-symbols-outlined text-green-600 dark:text-green-400 !text-xl">check_circle</span>
                                        <div>
                                            <p class="text-green-800 dark:text-green-300 font-semibold"
                                                id="applied-code"></p>
                                            <p class="text-green-600 dark:text-green-400 text-xs">You saved $<span
                                                    id="discount-amount">0</span></p>
                                        </div>
                                    </div>
                                    <button onclick="removeCoupon()"
                                        class="text-red-600 dark:text-red-400 text-sm font-medium hover:underline">Remove</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="py-4 space-y-2 border-t border-gray-200 dark:border-gray-700">
                        <div class="flex justify-between text-sm text-gray-500 dark:text-gray-400">
                            <p>Subtotal</p>
                            <p>${{ cart.subtotal }}</p>
                        </div>
                        <div class="flex justify-between text-sm text-gray-500 dark:text-gray-400">
                            <p>Delivery Fee</p>
                            <p id="fee-display">${{ restaurant.delivery_fee }}</p>
                        </div>
                        <div class="flex justify-between text-sm text-gray-500 dark:text-gray-400">
                            <p>Taxes & Fees</p>
                            <p id="checkout-tax">$0.00</p>
                        </div>
                        <div id="discount-row"
                            class="hidden flex justify-between text-sm text-green-600 dark:text-green-400 font-medium">
                            <p>Discount</p>
                            <p>-$<span id="discount-display">0.00</span></p>
                        </div>
                    </div>

                    <div class="flex justify-between items-center pt-4 border-t border-gray-200 dark:border-gray-700">
                        <p class="text-lg font-bold text-gray-900 dark:text-white">Total</p>
                        <p class="text-2xl font-black text-gray-900 dark:text-white" id="checkout-total">$0.00</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://js.paystack.co/v1/inline.js"></script>
<script>
    // Base values from template
    // Use unlocalize/stringformat to ensure dot decimal separator
    const baseSubtotal = parseFloat('{{ cart.subtotal|stringformat:"f" }}') || 0;
    const baseDeliveryFee = parseFloat('{{ restaurant.delivery_fee|stringformat:"f" }}') || 0;
    const taxRate = 0.08;
    let currentDeliveryFee = baseDeliveryFee;

    function setDeliveryType(type) {
        console.log('Setting delivery type to:', type);
        const addressSection = document.getElementById('address-section');

        if (!addressSection) {
            console.error('Address section not found!');
            return;
        }

        // Update UI state for radio button labels
        document.querySelectorAll('input[name="delivery_type"]').forEach(input => {
            const label = input.closest('label');
            if (input.value === type) {
                label.classList.add('border-primary', 'bg-primary/5');
                label.classList.remove('border-gray-200', 'dark:border-gray-700');
                input.checked = true;
            } else {
                label.classList.remove('border-primary', 'bg-primary/5');
                label.classList.add('border-gray-200', 'dark:border-gray-700');
                input.checked = false;
            }
        });

        if (type === 'pickup') {
            // Hide address section completely
            addressSection.style.display = 'none';
            currentDeliveryFee = 0;
            
            // Disable required validation for address fields when pickup is selected
            const addressFields = addressSection.querySelectorAll('input[required], select[required], textarea[required]');
            addressFields.forEach(el => {
                el.dataset.wasRequired = 'true';  // Store original state
                el.removeAttribute('required');
            });
            
            console.log('✓ Pickup mode: Address fields hidden and validation disabled');
        } else {
            // Show address section (restore original display - grid)
            addressSection.style.display = '';
            currentDeliveryFee = baseDeliveryFee;
            
            // Restore required validation for address fields
            const addressFields = addressSection.querySelectorAll('[data-was-required]');
            addressFields.forEach(el => {
                el.setAttribute('required', 'true');
                el.removeAttribute('data-was-required');
            });
            
            console.log('✓ Delivery mode: Address fields shown and validation enabled');
        }

        updatePricing();
    }

    function updatePricing() {
        const tax = baseSubtotal * taxRate;
        const discount = typeof appliedDiscount !== 'undefined' ? appliedDiscount : 0;
        const total = baseSubtotal + currentDeliveryFee + tax - discount;

        // Update displays
        const taxElement = document.getElementById('checkout-tax');
        if (taxElement) taxElement.textContent = '$' + tax.toFixed(2);

        const feeDisplay = document.getElementById('fee-display');
        if (feeDisplay) feeDisplay.textContent = currentDeliveryFee > 0 ? '$' + currentDeliveryFee.toFixed(2) : 'Free';

        const totalElement = document.getElementById('checkout-total');
        if (totalElement) totalElement.textContent = '$' + total.toFixed(2);
    }

    // Initialize UI and events on DOM content loaded
    document.addEventListener('DOMContentLoaded', function () {
        console.log('✓ Checkout page initialized');

        // Add event listeners for delivery type changes FIRST
        document.querySelectorAll('input[name="delivery_type"]').forEach(input => {
            input.addEventListener('change', (e) => {
                console.log('Delivery type changed via radio button:', e.target.value);
                setDeliveryType(e.target.value);
            });
            
            // Also handle clicks on the label
            const label = input.closest('label');
            if (label) {
                label.addEventListener('click', (e) => {
                    // Let the radio button handle the change
                    setTimeout(() => {
                        const selectedType = document.querySelector('input[name="delivery_type"]:checked')?.value;
                        if (selectedType) {
                            console.log('Delivery type changed via label click:', selectedType);
                            setDeliveryType(selectedType);
                        }
                    }, 10);
                });
            }
        });

        // Initialize delivery type state based on checked radio button
        const checkedDelivery = document.querySelector('input[name="delivery_type"]:checked');
        if (checkedDelivery) {
            console.log('Initial delivery type:', checkedDelivery.value);
            setDeliveryType(checkedDelivery.value);
        } else {
            // Default to delivery if none checked
            console.log('No delivery type checked, defaulting to delivery');
            setDeliveryType('delivery');
        }

        // Initialize pricing
        updatePricing();
        
        console.log('✓ Checkout ready - Pickup/Delivery toggle is active');
    });

    function proceedToPayment() {
        const form = document.getElementById('checkout-form');
        const formData = new FormData(form);

        // Validate form
        if (!form.checkValidity()) {
            form.reportValidity();
            return;
        }

        // Get selected payment method
        const paymentMethod = formData.get('payment_method');
        const deliveryType = document.querySelector('input[name="delivery_type"]:checked').value;

        // Get cart items and prepare order data
        const cartItems = [
            {% for item in cart.cart_items.all %}
            {
                menu_item_id: {{ item.menu_item.id }},
                quantity: {{ item.quantity }},
                customizations: {{ item.customizations|safe|default:"{}"}},
                special_instructions: ""
            }{% if not forloop.last %},{% endif %}
            {% endfor %}
        ];

        // Create order via API
        const orderData = {
            restaurant_id: {{ restaurant.id }},
            items: cartItems,
            delivery_type: deliveryType,
            delivery_address: deliveryType === 'delivery' ? (formData.get('delivery_address') || '') : '',
            delivery_city: deliveryType === 'delivery' ? (formData.get('delivery_city') || '') : '',
            delivery_state: deliveryType === 'delivery' ? (formData.get('delivery_state') || '') : '',
            delivery_postal_code: deliveryType === 'delivery' ? (formData.get('delivery_postal_code') || '') : '',
            contact_phone: formData.get('contact_phone'),
            contact_email: '{{ user.email }}',
            delivery_instructions: formData.get('delivery_instructions') || '',
            special_requests: '',
            payment_method: paymentMethod
        };

        console.log('Sending order data:', orderData);

        fetch('/api/orders/orders/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify(orderData)
        })
            .then(response => {
                const contentType = response.headers.get('content-type');
                if (contentType && contentType.includes('application/json')) {
                    return response.json().then(data => {
                        if (!response.ok) throw new Error(JSON.stringify(data));
                        return data;
                    });
                } else {
                    return response.text().then(text => {
                        throw new Error('Server returned an unexpected response');
                    });
                }
            })
            .then(data => {
                if (data.order_number) {
                    if (paymentMethod === 'cod') {
                        window.location.href = `/orders/order/${data.order_number}/track/`;
                    } else {
                        initializePayment(data.order_number, data.total, data.id);
                    }
                } else {
                    alert('Error creating order. Please try again.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                try {
                    const errObj = JSON.parse(error.message);
                    let msg = 'Failed to create order:\n';
                    for (let key in errObj) {
                        msg += `${key}: ${errObj[key]}\n`;
                    }
                    alert(msg);
                } catch (e) {
                    alert('Failed to create order: ' + error.message);
                }
            });
    }

    function initializePayment(orderNumber, amount, orderId) {
        fetch(`/payments/initialize/${orderId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            }
        })
            .then(response => response.json())
            .then(paymentData => {
                if (paymentData.error) {
                    alert('Payment initialization failed: ' + paymentData.error);
                    return;
                }
                openPaystack(paymentData.reference, orderNumber, amount);
            })
            .catch(error => {
                console.error('Payment initialization error:', error);
                alert('Failed to initialize payment. Please try again.');
            });
    }

    function openPaystack(paymentReference, orderNumber, amount) {
        const paystackKey = '{{ PAYSTACK_PUBLIC_KEY|default:"" }}';
        if (!paystackKey) {
            alert('Payment system not configured. Please contact support.');
            return;
        }

        const handler = PaystackPop.setup({
            key: paystackKey,
            email: '{{ user.email }}',
            amount: Math.round(amount * 100),
            currency: 'NGN',
            ref: paymentReference,
            callback: function (response) {
                window.location.href = `/payments/verify/${response.reference}/`;
            },
            onClose: function () {
                alert('Payment window closed. You can complete payment later from your orders page.');
                window.location.href = `/orders/order/${orderNumber}/`;
            }
        });
        handler.openIframe();
    }

    // Coupon tracking
    let appliedDiscount = 0;

    async function applyCoupon() {
        const code = document.getElementById('coupon-code').value.trim();
        const applyBtn = document.getElementById('apply-coupon-btn');
        const messageDiv = document.getElementById('coupon-message');

        if (!code) {
            showCouponMessage('Please enter a coupon code', 'error');
            return;
        }

        applyBtn.disabled = true;
        applyBtn.textContent = 'Applying...';

        try {
            const response = await fetch('/orders/coupon/apply/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({ code: code })
            });

            const data = await response.json();

            if (response.ok && data.success) {
                appliedDiscount = data.discount;
                document.getElementById('applied-code').textContent = code.toUpperCase();
                document.getElementById('discount-amount').textContent = data.discount.toFixed(2);
                document.getElementById('discount-display').textContent = data.discount.toFixed(2);
                document.getElementById('applied-coupon').classList.remove('hidden');
                document.getElementById('discount-row').classList.remove('hidden');
                document.getElementById('coupon-input-container').classList.add('hidden');
                messageDiv.classList.add('hidden');
                updateCheckoutTotal(data.new_total);
                showCouponMessage(data.message, 'success');
                document.getElementById('coupon-code').value = '';
            } else {
                showCouponMessage(data.error || 'Failed to apply coupon', 'error');
            }
        } catch (error) {
            console.error('Error applying coupon:', error);
            showCouponMessage('Failed to apply coupon. Please try again.', 'error');
        } finally {
            applyBtn.disabled = false;
            applyBtn.textContent = 'Apply';
        }
    }

    async function removeCoupon() {
        try {
            const response = await fetch('/orders/coupon/remove/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                }
            });

            const data = await response.json();
            if (response.ok && data.success) {
                appliedDiscount = 0;
                document.getElementById('applied-coupon').classList.add('hidden');
                document.getElementById('discount-row').classList.add('hidden');
                document.getElementById('coupon-input-container').classList.remove('hidden');
                document.getElementById('coupon-message').classList.add('hidden');
                updateCheckoutTotal(data.new_total);
                document.getElementById('coupon-code').value = '';
            }
        } catch (error) {
            console.error('Error removing coupon:', error);
        }
    }

    function showCouponMessage(message, type) {
        const messageDiv = document.getElementById('coupon-message');
        messageDiv.textContent = message;
        messageDiv.className = `mt-2 text-sm ${type === 'error' ? 'text-red-600 dark:text-red-400' : 'text-green-600 dark:text-green-400'}`;
        messageDiv.classList.remove('hidden');
        if (type === 'success') {
            setTimeout(() => { messageDiv.classList.add('hidden'); }, 3000);
        }
    }

    function updateCheckoutTotal(newTotal) {
        const totalElement = document.getElementById('checkout-total');
        if (totalElement) {
            totalElement.textContent = `$${parseFloat(newTotal).toFixed(2)}`;
        }
    }

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    document.getElementById('coupon-code').addEventListener('keypress', function (e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            applyCoupon();
        }
    });
</script>
{% endblock %}