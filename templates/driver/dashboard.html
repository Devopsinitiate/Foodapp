{% extends "base.html" %}
{% load static %}

{% block title %}Driver Dashboard{% endblock %}

{% block content %}
<divclass="min-h-screen bg-gray-50 dark:bg-gray-900">
    <!-- Header -->
    <div class="bg-white dark:bg-gray-800 shadow">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-2xl font-bold text-gray-900 dark:text-white">Driver Dashboard</h1>
                    <p class="text-sm text-gray-600 dark:text-gray-400">{{ user.get_full_name|default:user.username }}
                    </p>
                </div>
                <div class="flex items-center gap-3">
                    <!-- Availability Toggle -->
                    <form method="post" action="{% url 'delivery:toggle_availability' %}">
                        {% csrf_token %}
                        <button type="submit"
                            class="flex items-center gap-2 px-4 py-2 rounded-lg {% if is_available %}bg-green-600 hover:bg-green-700{% else %}bg-gray-600 hover:bg-gray-700{% endif %} text-white transition-colors">
                            <span class="material-symbols-outlined !text-lg">{% if is_available %}check_circle{% else %}cancel{% endif %}</span>
                            <span class="font-medium">{% if is_available %}Online{% else %}Offline{% endif %}</span>
                        </button>
                    </form>
                    <a href="{% url 'delivery:earnings_dashboard' %}"
                        class="flex items-center gap-2 px-4 py-2 rounded-lg bg-primary hover:bg-primary-dark text-white">
                        <span class="material-symbols-outlined !text-lg">payments</span>
                        <span class="font-medium">Earnings</span>
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Earnings Cards -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <!-- Today -->
            <div class="bg-white dark:bg-gray-800 rounded-xl p-6 shadow-sm">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-sm text-gray-600 dark:text-gray-400">Today</span>
                    <div
                        class="w-10 h-10 bg-green-100 dark:bg-green-900/30 rounded-lg flex items-center justify-center">
                        <span class="material-symbols-outlined text-green-600 dark:text-green-400">today</span>
                    </div>
                </div>
                <p class="text-3xl font-bold text-gray-900 dark:text-white">${{ today_earnings|floatformat:2 }}</p>
                <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">{{ today_count }} deliveries</p>
            </div>

            <!-- This Week -->
            <div class="bg-white dark:bg-gray-800 rounded-xl p-6 shadow-sm">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-sm text-gray-600 dark:text-gray-400">This Week</span>
                    <div class="w-10 h-10 bg-blue-100 dark:bg-blue-900/30 rounded-lg flex items-center justify-center">
                        <span class="material-symbols-outlined text-blue-600 dark:text-blue-400">calendar_month</span>
                    </div>
                </div>
                <p class="text-3xl font-bold text-gray-900 dark:text-white">${{ week_earnings|floatformat:2 }}</p>
                <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">Last 7 days</p>
            </div>

            <!-- This Month -->
            <div class="bg-white dark:bg-gray-800 rounded-xl p-6 shadow-sm">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-sm text-gray-600 dark:text-gray-400">This Month</span>
                    <div
                        class="w-10 h-10 bg-purple-100 dark:bg-purple-900/30 rounded-lg flex items-center justify-center">
                        <span class="material-symbols-outlined text-purple-600 dark:text-purple-400">insights</span>
                    </div>
                </div>
                <p class="text-3xl font-bold text-gray-900 dark:text-white">${{ month_earnings|floatformat:2 }}</p>
                <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">Month to date</p>
            </div>
        </div>

        <!-- Performance Stats -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="bg-white dark:bg-gray-800 rounded-xl p-6 shadow-sm text-center">
                <p class="text-sm text-gray-600 dark:text-gray-400 mb-2">Total Deliveries</p>
                <p class="text-4xl font-bold text-primary">{{ total_deliveries }}</p>
            </div>
            <div class="bg-white dark:bg-gray-800 rounded-xl p-6 shadow-sm text-center">
                <p class="text-sm text-gray-600 dark:text-gray-400 mb-2">Average Rating</p>
                <p class="text-4xl font-bold text-primary">{{ avg_rating|floatformat:1 }}‚≠ê</p>
            </div>
            <div class="bg-white dark:bg-gray-800 rounded-xl p-6 shadow-sm text-center">
                <p class="text-sm text-gray-600 dark:text-gray-400 mb-2">Completion Rate</p>
                <p class="text-4xl font-bold text-primary">{{ completion_rate|floatformat:0 }}%</p>
            </div>
        </div>

        <!-- Active Delivery -->
        {% if active_delivery %}
        <div class="bg-gradient-to-r from-primary to-orange-600 rounded-xl p-6 mb-8 text-white shadow-lg">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-bold flex items-center gap-2">
                    <span class="material-symbols-outlined">local_shipping</span>
                    Active Delivery
                </h2>
                <span class="px-3 py-1 bg-white/20 rounded-full text-sm font-medium">
                    {{ active_delivery.get_status_display }}
                </span>
            </div>
            <div class="bg-white/10 rounded-lg p-4 mb-4">
                <p class="font-semibold mb-2">Order #{{ active_delivery.order.order_number }}</p>
                <p class="text-sm opacity-90">{{ active_delivery.order.restaurant.name }}</p>
                <p class="text-sm opacity-90">{{ active_delivery.order.delivery_address }}</p>
                <p class="text-lg font-bold mt-3">Earnings: ${{ active_delivery.order.delivery_fee }}</p>
            </div>
            <div class="flex gap-3">
                <a href="{% url 'delivery:active_delivery' active_delivery.id %}"
                    class="flex-1 bg-white text-primary px-4 py-3 rounded-lg font-medium text-center hover:bg-gray-100 transition-colors">
                    View Details
                </a>
                {% if active_delivery.status == 'assigned' %}
                <form method="post" action="{% url 'delivery:accept_delivery' active_delivery.id %}" class="flex-1">
                    {% csrf_token %}
                    <button type="submit"
                        class="w-full bg-green-600 text-white px-4 py-3 rounded-lg font-medium hover:bg-green-700 transition-colors">
                        Accept Delivery
                    </button>
                </form>
                {% elif active_delivery.status == 'accepted' %}
                <form method="post" action="{% url 'delivery:mark_picked_up' active_delivery.id %}" class="flex-1">
                    {% csrf_token %}
                    <button type="submit"
                        class="w-full bg-green-600 text-white px-4 py-3 rounded-lg font-medium hover:bg-green-700 transition-colors">
                        Mark Picked Up
                    </button>
                </form>
                {% elif active_delivery.status == 'picked_up' %}
                <form method="post" action="{% url 'delivery:mark_delivered' active_delivery.id %}" class="flex-1">
                    {% csrf_token %}
                    <button type="submit"
                        class="w-full bg-green-600 text-white px-4 py-3 rounded-lg font-medium hover:bg-green-700 transition-colors">
                        Mark Delivered
                    </button>
                </form>
                {% endif %}
            </div>
        </div>
        {% endif %}

        <!-- Available Deliveries -->
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm">
            <div class="p-6 border-b border-gray-200 dark:border-gray-700">
                <div class="flex items-center justify-between">
                    <h2 class="text-xl font-bold text-gray-900 dark:text-white">Available Deliveries</h2>
                    <a href="{% url 'delivery:available_deliveries' %}"
                        class="text-primary hover:underline text-sm">View All</a>
                </div>
            </div>
            <div class="p-6">
                {% if available_deliveries %}
                <div class="space-y-4">
                    {% for delivery in available_deliveries %}
                    <div
                        class="border border-gray-200 dark:border-gray-700 rounded-lg p-4 hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors">
                        <div class="flex items-start justify-between mb-3">
                            <div class="flex-1">
                                <p class="font-semibold text-gray-900 dark:text-white">{{ delivery.order.restaurant.name }}</p>
                                <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">{{ delivery.order.delivery_address }}</p>
                                <p class="text-sm text-gray-600 dark:text-gray-400">Order #{{ delivery.order.order_number }}</p>
                            </div>
                            <div class="text-right">
                                <p class="font-bold text-green-600 dark:text-green-400 text-lg">${{ delivery.order.delivery_fee }}</p>
                                {% if delivery.distance_km %}
                                <p class="text-sm text-gray-600 dark:text-gray-400">{{ delivery.distance_km }} km</p>
                                {% endif %}
                            </div>
                        </div>
                        <form method="post" action="{% url 'delivery:accept_delivery' delivery.id %}"
                            class="flex gap-2">
                            {% csrf_token %}
                            <button type="submit"
                                class="flex-1 bg-primary text-white px-4 py-2 rounded-lg font-medium hover:bg-primary-dark transition-colors">
                                Accept
                            </button>
                            <button type="button" onclick="this.closest('form').parentElement.remove()"
                                class="px-4 py-2 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                                Skip
                            </button>
                        </form>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-center text-gray-500 dark:text-gray-400 py-12">No available deliveries at the moment</p>
                {% endif %}
            </div>
        </div>

        <!-- Quick Links -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-8">
            <a href="{% url 'delivery:delivery_history' %}"
                class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm hover:shadow-md transition-shadow text-center">
                <span class="material-symbols-outlined text-4xl text-primary mb-2">history</span>
                <p class="font-medium text-gray-900 dark:text-white">History</p>
            </a>
            <a href="{% url 'delivery:earnings_dashboard' %}"
                class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm hover:shadow-md transition-shadow text-center">
                <span class="material-symbols-outlined text-4xl text-primary mb-2">account_balance_wallet</span>
                <p class="font-medium text-gray-900 dark:text-white">Earnings</p>
            </a>
            <a href="{% url 'delivery:available_deliveries' %}"
                class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm hover:shadow-md transition-shadow text-center">
                <span class="material-symbols-outlined text-4xl text-primary mb-2">list_alt</span>
                <p class="font-medium text-gray-900 dark:text-white">Available</p>
            </a>
            <a href="{% url 'users:profile' %}"
                class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm hover:shadow-md transition-shadow text-center">
                <span class="material-symbols-outlined text-4xl text-primary mb-2">person</span>
                <p class="font-medium text-gray-900 dark:text-white">Profile</p>
            </a>
        </div>
    </div>
    </div>
    {% endblock %}