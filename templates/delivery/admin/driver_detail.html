{% extends 'base.html' %}
{% load static %}

{% block title %}Driver Application - {{ driver.get_full_name }}{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8 max-w-6xl">
    <!-- Header with Back Button -->
    <div class="mb-8">
        <a href="{% url 'delivery:admin_driver_applications' %}"
            class="text-primary hover:text-primary/80 flex items-center mb-4">
            <span class="material-symbols-outlined mr-2">arrow_back</span>
            Back to Applications
        </a>
        <div class="flex justify-between items-start">
            <div>
                <h1 class="text-4xl font-black text-gray-900 dark:text-white mb-2">{{ driver.get_full_name }}</h1>
                <p class="text-gray-600 dark:text-gray-400">Driver Application Review</p>
            </div>
            <div>
                {% if driver.is_verified_driver %}
                <span class="px-4 py-2 bg-green-100 text-green-700 rounded-lg font-semibold">✓ Approved</span>
                {% elif driver.driver_documents_uploaded %}
                <span class="px-4 py-2 bg-yellow-100 text-yellow-700 rounded-lg font-semibold">⏳ Pending Review</span>
                {% else %}
                <span class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg font-semibold">Incomplete</span>
                {% endif %}
            </div>
        </div>
    </div>

    {% if messages %}
    <div class="mb-6">
        {% for message in messages %}
        <div
            class="p-4 rounded-lg {% if message.tags == 'error' or message.tags == 'warning' %}bg-red-100 text-red-700{% else %}bg-green-100 text-green-700{% endif %}">
            {{ message }}
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- Left Column: Driver Information -->
        <div class="lg:col-span-2 space-y-6">
            <!-- Personal Information -->
            <div class="bg-white dark:bg-gray-900 rounded-xl shadow-lg p-6 border border-gray-200 dark:border-gray-800">
                <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-6 flex items-center">
                    <span class="material-symbols-outlined text-primary mr-2">person</span>
                    Personal Information
                </h2>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <p class="text-sm text-gray-600 dark:text-gray-400">Full Name</p>
                        <p class="font-semibold text-gray-900 dark:text-white">{{ driver.get_full_name }}</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600 dark:text-gray-400">Username</p>
                        <p class="font-semibold text-gray-900 dark:text-white">@{{ driver.username }}</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600 dark:text-gray-400">Email</p>
                        <p class="font-semibold text-gray-900 dark:text-white">{{ driver.email }}</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600 dark:text-gray-400">Phone</p>
                        <p class="font-semibold text-gray-900 dark:text-white">{{ driver.phone_number }}</p>
                    </div>
                    <div class="col-span-2">
                        <p class="text-sm text-gray-600 dark:text-gray-400">Address</p>
                        <p class="font-semibold text-gray-900 dark:text-white">{{ driver.full_address }}</p>
                    </div>
                </div>
            </div>

            <!-- License Information -->
            <div class="bg-white dark:bg-gray-900 rounded-xl shadow-lg p-6 border border-gray-200 dark:border-gray-800">
                <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-6 flex items-center">
                    <span class="material-symbols-outlined text-primary mr-2">badge</span>
                    Driver License
                </h2>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <p class="text-sm text-gray-600 dark:text-gray-400">License Number</p>
                        <p class="font-semibold text-gray-900 dark:text-white">{{ driver.driver_license_number }}</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600 dark:text-gray-400">Expiry Date</p>
                        <p
                            class="font-semibold text-gray-900 dark:text-white {% if driver.driver_license_expiry < today %}text-red-600{% endif %}">
                            {{ driver.driver_license_expiry|date:"M d, Y" }}
                        </p>
                    </div>
                </div>
            </div>

            <!-- Vehicle Information -->
            <div class="bg-white dark:bg-gray-900 rounded-xl shadow-lg p-6 border border-gray-200 dark:border-gray-800">
                <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-6 flex items-center">
                    <span class="material-symbols-outlined text-primary mr-2">directions_car</span>
                    Vehicle Information
                </h2>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <p class="text-sm text-gray-600 dark:text-gray-400">Vehicle Type</p>
                        <p class="font-semibold text-gray-900 dark:text-white">{{ driver.get_vehicle_type_display }}</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600 dark:text-gray-400">License Plate</p>
                        <p class="font-semibold text-gray-900 dark:text-white">{{ driver.vehicle_plate }}</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600 dark:text-gray-400">Insurance Expiry</p>
                        <p
                            class="font-semibold text-gray-900 dark:text-white {% if driver.vehicle_insurance_expiry < today %}text-red-600{% endif %}">
                            {{ driver.vehicle_insurance_expiry|date:"M d, Y" }}
                        </p>
                    </div>
                </div>
            </div>

            <!-- Uploaded Documents -->
            <div class="bg-white dark:bg-gray-900 rounded-xl shadow-lg p-6 border border-gray-200 dark:border-gray-800">
                <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-6 flex items-center">
                    <span class="material-symbols-outlined text-primary mr-2">folder_open</span>
                    Uploaded Documents
                </h2>
                <div class="grid grid-cols-1 gap-4">
                    {% if documents.license %}
                    <div class="border border-gray-200 dark:border-gray-700 rounded-lg p-4">
                        <p class="font-semibold mb-2">Driver License</p>
                        <img src="{{ documents.license }}" alt="Driver License" class="w-full rounded-lg">
                    </div>
                    {% endif %}
                    {% if documents.registration %}
                    <div class="border border-gray-200 dark:border-gray-700 rounded-lg p-4">
                        <p class="font-semibold mb-2">Vehicle Registration</p>
                        <img src="{{ documents.registration }}" alt="Vehicle Registration" class="w-full rounded-lg">
                    </div>
                    {% endif %}
                    {% if documents.insurance %}
                    <div class="border border-gray-200 dark:border-gray-700 rounded-lg p-4">
                        <p class="font-semibold mb-2">Insurance Certificate</p>
                        <img src="{{ documents.insurance }}" alt="Insurance Certificate" class="w-full rounded-lg">
                    </div>
                    {% endif %}
                    {% if not documents.license and not documents.registration and not documents.insurance %}
                    <p class="text-gray-500 dark:text-gray-400 text-center py-8">No documents uploaded yet</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Right Column: Actions -->
        <div class="space-y-6">
            <!-- Performance Stats -->
            <div class="bg-white dark:bg-gray-900 rounded-xl shadow-lg p-6 border border-gray-200 dark:border-gray-800">
                <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-4">Performance</h3>
                <div class="space-y-3">
                    <div>
                        <p class="text-sm text-gray-600 dark:text-gray-400">Total Deliveries</p>
                        <p class="text-2xl font-black text-gray-900 dark:text-white">{{ availability.total_deliveries }}
                        </p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600 dark:text-gray-400">Success Rate</p>
                        <p class="text-2xl font-black text-primary">{{ availability.success_rate|floatformat:1 }}%</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600 dark:text-gray-400">Average Rating</p>
                        <p class="text-2xl font-black text-gray-900 dark:text-white">{{ availability.average_rating|floatformat:1 }}</p>
                    </div>
                </div>
            </div>

            <!-- Actions -->
            <div class="bg-white dark:bg-gray-900 rounded-xl shadow-lg p-6 border border-gray-200 dark:border-gray-800">
                <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-4">Actions</h3>
                <div class="space-y-3">
                    {% if not driver.is_verified_driver and driver.driver_documents_uploaded %}
                    <form method="post" action="{% url 'delivery:admin_approve_driver' driver.id %}">
                        {% csrf_token %}
                        <button type="submit"
                            class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-lg flex items-center justify-center">
                            <span class="material-symbols-outlined mr-2">check_circle</span>
                            Approve Driver
                        </button>
                    </form>

                    <button onclick="showRejectModal()"
                        class="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-4 rounded-lg flex items-center justify-center">
                        <span class="material-symbols-outlined mr-2">cancel</span>
                        Reject Application
                    </button>
                    {% elif driver.is_verified_driver %}
                    <button onclick="showDeactivateModal()"
                        class="w-full bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-3 px-4 rounded-lg flex items-center justify-center">
                        <span class="material-symbols-outlined mr-2">block</span>
                        Deactivate Driver
                    </button>
                    {% endif %}

                    <a href="mailto:{{ driver.email }}"
                        class="w-full bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 text-gray-900 dark:text-white font-bold py-3 px-4 rounded-lg flex items-center justify-center">
                        <span class="material-symbols-outlined mr-2">email</span>
                        Contact Driver
                    </a>
                </div>
            </div>

            <!-- Application Details -->
            <div class="bg-white dark:bg-gray-900 rounded-xl shadow-lg p-6 border border-gray-200 dark:border-gray-800">
                <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-4">Details</h3>
                <div class="space-y-2 text-sm">
                    <div>
                        <span class="text-gray-600 dark:text-gray-400">Applied:</span>
                        <span class="font-semibold text-gray-900 dark:text-white">{{ driver.created_at|date:"M d, Y" }}</span>
                    </div>
                    <div>
                        <span class="text-gray-600 dark:text-gray-400">Documents:</span>
                        <span
                            class="font-semibold {% if driver.driver_documents_uploaded %}text-green-600{% else %}text-red-600{% endif %}">
                            {% if driver.driver_documents_uploaded %}Uploaded{% else %}Not Uploaded{% endif %}
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Reject Modal -->
<div id="rejectModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
    <div class="bg-white dark:bg-gray-900 rounded-xl p-6 max-w-md mx-4">
        <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-4">Reject Application</h3>
        <form method="post" action="{% url 'delivery:admin_reject_driver' driver.id %}">
            {% csrf_token %}
            <textarea name="reason" rows="4"
                class="w-full p-3 border border-gray-300 dark:border-gray-700 rounded-lg mb-4"
                placeholder="Reason for rejection (optional)"></textarea>
            <div class="flex gap-2">
                <button type="button" onclick="hideRejectModal()"
                    class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-900 font-bold py-2 px-4 rounded-lg">Cancel</button>
                <button type="submit"
                    class="flex-1 bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg">Reject</button>
            </div>
        </form>
    </div>
</div>

<!-- Deactivate Modal -->
<div id="deactivateModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
    <div class="bg-white dark:bg-gray-900 rounded-xl p-6 max-w-md mx-4">
        <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-4">Deactivate Driver</h3>
        <form method="post" action="{% url 'delivery:admin_deactivate_driver' driver.id %}">
            {% csrf_token %}
            <textarea name="reason" rows="4"
                class="w-full p-3 border border-gray-300 dark:border-gray-700 rounded-lg mb-4"
                placeholder="Reason for deactivation (optional)"></textarea>
            <div class="flex gap-2">
                <button type="button" onclick="hideDeactivateModal()"
                    class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-900 font-bold py-2 px-4 rounded-lg">Cancel</button>
                <button type="submit"
                    class="flex-1 bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded-lg">Deactivate</button>
            </div>
        </form>
    </div>
</div>

<script>
    function showRejectModal() {
        document.getElementById('rejectModal').classList.remove('hidden');
    }
    function hideRejectModal() {
        document.getElementById('rejectModal').classList.add('hidden');
    }
    function showDeactivateModal() {
        document.getElementById('deactivateModal').classList.remove('hidden');
    }
    function hideDeactivateModal() {
        document.getElementById('deactivateModal').classList.add('hidden');
    }
</script>
{% endblock %}